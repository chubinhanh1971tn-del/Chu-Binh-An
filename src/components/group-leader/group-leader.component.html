<div class="flex h-screen bg-white font-sans">
  <!-- Sidebar -->
  <aside class="w-64 bg-gray-800 text-white flex flex-col">
    <div class="h-16 flex items-center justify-center border-b border-gray-700">
        <a routerLink="/" class="text-xl font-bold text-yellow-400">MGA365</a>
    </div>
    @if(currentUser(); as user) {
        <div class="p-4 border-b border-gray-700">
            <h3 class="text-lg font-semibold">{{ user.name }}</h3>
            <p class="text-sm text-gray-400">Trưởng Nhóm: {{ user.group }}</p>
        </div>
    }
    <nav class="flex-1 px-4 py-6 space-y-2">
        <button (click)="activeMenu.set('properties')" 
            class="w-full flex items-center px-4 py-2 rounded-md transition-colors"
            [class]="activeMenu() === 'properties' ? 'bg-gray-700 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'">
            <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg>
            <span>Tin đăng trong Nhóm</span>
        </button>
        <button (click)="activeMenu.set('members')" 
            class="w-full flex items-center px-4 py-2 rounded-md transition-colors"
            [class]="activeMenu() === 'members' ? 'bg-gray-700 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'">
            <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962A3.375 3.375 0 0110.5 9h3.375c1.621 0 3.09 1.04 3.09 2.625v3.75" /> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 14.25V18a2.25 2.25 0 002.25 2.25h1.5M16.5 18.75h-1.5a2.25 2.25 0 01-2.25-2.25v-3.75a3.375 3.375 0 013.375-3.375h1.5a2.25 2.25 0 012.25 2.25v3.75M6 18.75a3 3 0 003-3v-3.75" /></svg>
            <span>Quản lý Thành viên</span>
        </button>
    </nav>
  </aside>

  <!-- Main content -->
  <main class="flex-1 p-2 sm:p-4 overflow-y-auto">
    @switch (activeMenu()) {
      @case ('properties') {
        <div class="bg-white rounded-lg shadow-md">
            <div class="p-4 sm:p-6 border-b flex flex-wrap justify-between items-center gap-4">
                @if(currentUser(); as user) {
                    <div>
                        <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Quản lý Nhóm: {{ user.group }}</h1>
                        <p class="text-gray-600 mt-1 text-sm sm:text-base">Xem và quản lý các tin đăng từ các thành viên trong nhóm của bạn.</p>
                    </div>
                }
                <div class="flex items-center gap-4 w-full sm:w-auto">
                    <div class="relative flex-grow">
                        <input 
                            type="text" 
                            placeholder="Tìm theo tiêu đề, địa chỉ..."
                            class="w-full pl-4 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-600 transition"
                            [value]="searchTerm()"
                            (input)="onSearch($event)">
                    </div>
                    <button (click)="isAddModalOpen.set(true)" class="bg-yellow-500 text-gray-900 font-semibold py-2 px-4 rounded-lg hover:bg-yellow-400 transition-colors flex items-center gap-2 shrink-0">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        <span class="hidden sm:inline">Thêm BĐS</span>
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-600 min-w-[900px]">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3">Tiêu đề</th>
                            <th scope="col" class="px-4 py-3">Loại</th>
                            <th scope="col" class="px-4 py-3">Giá</th>
                            <th scope="col" class="px-4 py-3">Đơn Giá</th>
                            <th scope="col" class="px-4 py-3">Diện tích</th>
                            <th scope="col" class="px-4 py-3">Người đăng</th>
                            <th scope="col" class="px-4 py-3 text-center">Nổi bật</th>
                            <th scope="col" class="px-4 py-3 text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (property of properties(); track property.id) {
                            <tr [class]="getRowClass(property)" class="border-b hover:brightness-95 transition-all duration-200">
                                <td class="px-4 py-3 font-medium text-gray-900">
                                    <div class="font-semibold">{{ property.title }}</div>
                                    <div class="text-xs text-gray-500">{{ property.address }}</div>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full" [class]="getTypeClass(property.type)">
                                        {{ property.type }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 font-semibold text-gray-800">{{ formatDisplayPrice(property) }}</td>
                                <td class="px-2 py-3 text-xs font-medium text-gray-600">
                                  @if(property.price > 0 && property.area > 0) {
                                    <span>{{ (property.price / property.area / 1000000).toFixed(2) }} tr/m²</span>
                                  } @else {
                                    <span>-</span>
                                  }
                                </td>
                                <td class="px-4 py-3 font-semibold text-gray-800">{{ property.area }} m²</td>
                                <td class="px-4 py-3 text-xs">{{ property.collaboratorName ?? '—' }}</td>
                                <td class="px-4 py-3">
                                    @if(property.featured) {
                                        <span class="text-yellow-500 flex justify-center">
                                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c.321-.772 1.305-.772 1.626 0l1.833 4.432a1.25 1.25 0 00.945.678l4.883.709c.852.124 1.191 1.166.574 1.768l-3.533 3.443a1.25 1.25 0 00-.363 1.114l.835 4.865c.145.848-.743 1.498-1.503 1.107l-4.366-2.296a1.25 1.25 0 00-1.164 0l-4.366 2.296c-.76.391-1.648-.259-1.503-1.107l.835-4.865a1.25 1.25 0 00-.363-1.114L2.01 9.87c-.617-.602-.278-1.644.574-1.768l4.883-.709a1.25 1.25 0 00.945-.678l1.833-4.432z" clip-rule="evenodd" /></svg>
                                        </span>
                                    }
                                </td>
                                <td class="px-4 py-3 text-right space-x-2 whitespace-nowrap">
                                    <button (click)="toggleFeatured(property)" class="font-medium text-gray-500 hover:text-yellow-600 p-1" title="Toggle Featured">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.31h5.418a.562.562 0 01.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.562.562 0 01.321-.988h5.418a.563.563 0 00.475-.31L11.48 3.5z" /></svg>
                                    </button>
                                    <button (click)="deleteProperty(property)" class="font-medium text-red-600 hover:text-red-800 p-1" title="Xóa">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                                    </button>
                                </td>
                            </tr>
                        } @empty {
                           <tr>
                                <td colspan="8" class="text-center py-8 text-gray-500">
                                    Chưa có tin đăng nào trong nhóm của bạn.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
      }
      @case ('members') {
        <div class="bg-white rounded-lg shadow-md">
            <div class="p-6 border-b flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Quản lý Thành viên Nhóm</h1>
                    <p class="text-gray-600 mt-1">Mời và xem các thành viên trong nhóm của bạn.</p>
                </div>
                <button (click)="openInviteModal()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z" /></svg>
                    <span>Mời Thành viên</span>
                </button>
            </div>
             <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">Tên</th>
                            <th scope="col" class="px-6 py-3">Email</th>
                            <th scope="col" class="px-6 py-3">Trạng thái</th>
                            <th scope="col" class="px-6 py-3 text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (member of groupMembers(); track member.id) {
                            <tr class="bg-white border-b hover:bg-gray-50">
                                <td class="px-6 py-4 font-medium text-gray-900">{{ member.name }}</td>
                                <td class="px-6 py-4">{{ member.email }}</td>
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full" [class]="getStatusClass(member.status)">
                                        {{ member.status === 'Active' ? 'Hoạt động' : 'Chờ duyệt' }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <button class="font-medium text-gray-500 hover:text-gray-800">...</button>
                                </td>
                            </tr>
                        } @empty {
                            <tr>
                                <td colspan="4" class="text-center py-8 text-gray-500">
                                    Chưa có thành viên nào trong nhóm.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
      }
    }
  </main>
</div>

@if(isAddModalOpen() && currentUser(); as user) {
    <app-add-property-modal 
        (close)="isAddModalOpen.set(false)"
        (propertyAdded)="handleAddProperty($event)"
        [initialSource]="'Đối tác MGA'"
        [initialCollaboratorName]="user.name">
    </app-add-property-modal>
}

@if(isInviteModalOpen()) {
    <div class="fixed inset-0 bg-black/60 z-40 flex items-center justify-center p-4 animate-fade-in" (click)="closeInviteModal()">
      <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto animate-scale-up" (click)="$event.stopPropagation()">
        <div class="flex justify-between items-center p-5 border-b border-gray-200">
          <h3 class="text-xl font-bold text-gray-800">Mời thành viên vào Nhóm</h3>
          <button (click)="closeInviteModal()" class="text-gray-400 hover:text-gray-600 transition-colors" aria-label="Đóng">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <div class="p-6">
            <p class="text-gray-600 mb-4">Sao chép và gửi liên kết này cho người bạn muốn mời. Khi họ đăng ký qua liên kết này, họ sẽ tự động được thêm vào nhóm của bạn với trạng thái "Chờ duyệt".</p>
            <div class="flex items-center gap-2">
                <input type="text" [value]="invitationLink()" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-700">
                <button (click)="copyInviteLink()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 shrink-0">
                   @if (inviteLinkCopied()) {
                     <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.052-.143Z" clip-rule="evenodd" /></svg>
                     <span>Đã chép!</span>
                   } @else {
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.057 1.123-.08M15.75 18H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08M15.75 18.75v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5A3.375 3.375 0 0 0 6.375 7.5H5.25m11.9-3.664A2.251 2.251 0 0 0 15 2.25h-1.5a2.251 2.251 0 0 0-2.25 2.25" /></svg>
                    <span>Sao chép</span>
                   }
                </button>
            </div>
        </div>
      </div>
    </div>
}
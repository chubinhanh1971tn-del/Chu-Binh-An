<div class="min-h-screen bg-white flex flex-col">
  <div class="flex-grow">
    <app-header 
      (headerFilterSelected)="onHeaderFilterSelected($event)">
    </app-header>

    <app-hero></app-hero>

    <main class="relative container mx-auto px-4 -mt-20" [class.pb-40]="compareIds().size > 0">
      <div class="bg-white rounded-xl shadow-2xl p-6 mb-8 border border-gray-200/50">
        <app-search-filter 
          [initialFilters]="filters()" 
          [regions]="availableRegions()"
          (filtersChanged)="onFiltersChanged($event)">
        </app-search-filter>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
        
        <!-- Left Column: Property List -->
        <div id="property-list-section" class="lg:col-span-2 h-[calc(100vh-10rem)] overflow-y-auto pr-4">
           <div class="flex justify-between items-center mb-6 sticky top-0 bg-white py-2 z-10">
              <h2 class="text-2xl font-bold text-gray-800">
                Kết quả
                <span class="text-gray-500 font-medium text-xl">({{ filteredProperties().length }})</span>
              </h2>
              <div class="flex items-center space-x-2">
                 <button (click)="viewMode.set('list')" class="p-2 rounded-md" [class.bg-gray-200]="viewMode() === 'list'" [class.text-gray-800]="viewMode() === 'list'" [class.text-gray-400]="viewMode() !== 'list'" title="Xem dạng danh sách">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                 </button>
                 <button (click)="viewMode.set('grid')" class="p-2 rounded-md" [class.bg-gray-200]="viewMode() === 'grid'" [class.text-gray-800]="viewMode() === 'grid'" [class.text-gray-400]="viewMode() !== 'grid'" title="Xem dạng lưới">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 8.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25v2.25A2.25 2.25 0 018.25 21H6a2.25 2.25 0 01-2.25-2.25v-2.25zM13.5 6A2.25 2.25 0 0115.75 3.75h2.25A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25A2.25 2.25 0 0113.5 8.25V6zM13.5 15.75A2.25 2.25 0 0115.75 13.5h2.25a2.25 2.25 0 012.25 2.25v2.25a2.25 2.25 0 01-2.25 2.25h-2.25a2.25 2.25 0 01-2.25-2.25v-2.25z" /></svg>
                 </button>
              </div>
          </div>
          
          @if (filteredProperties().length > 0) {
            <div 
              [class.space-y-6]="viewMode() === 'grid'"
              [class.space-y-4]="viewMode() === 'list'">
              @for (property of paginatedProperties(); track property.id; let i = $index) {
                <div (mouseenter)="onPropertyHover(property.id)" (mouseleave)="onPropertyHover(null)">
                  @if (viewMode() === 'grid') {
                     @if (property.listingType === 'Cho Thuê') {
                      <app-apartment-card 
                        [property]="property"
                        (detailClicked)="openPropertyDetail(property)">
                      </app-apartment-card>
                    } @else {
                      <app-property-card 
                        [property]="property" 
                        [priority]="i < 3"
                        (detailClicked)="openPropertyDetail(property)">
                      </app-property-card>
                    }
                  } @else {
                     <app-property-list-item
                      [property]="property"
                      [priority]="i < 3"
                      (detailClicked)="openPropertyDetail(property)">
                    </app-property-list-item>
                  }
                </div>
              }
            </div>
          } @else {
            <div class="text-center py-16 px-6 bg-white rounded-lg">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
              </svg>
              <h3 class="mt-2 text-lg font-medium text-gray-900">Không tìm thấy kết quả</h3>
              <p class="mt-1 text-sm text-gray-500">
                Vui lòng thử thay đổi bộ lọc hoặc tìm kiếm với từ khóa khác.
              </p>
            </div>
          }
          
          @if (totalPages() > 1) {
            <div class="mt-8">
              <app-pagination [currentPage]="currentPage()" [totalPages]="totalPages()" (pageChanged)="onPageChanged($event)"></app-pagination>
            </div>
          }
        </div>
        
        <!-- Right Column: Map -->
        <div class="lg:col-span-3">
          <div id="map-section" class="sticky top-24 h-[600px] lg:h-[calc(100vh-7.5rem)] rounded-xl overflow-hidden shadow-lg border">
            <app-map 
              [properties]="textFilteredProperties()"
              [highlightedPropertyId]="hoveredPropertyId()"
              [aiSearchLocation]="aiSearchLocation()"
              (detailClicked)="openPropertyDetail($event)"
              (boundsChanged)="onMapBoundsChanged($event)"
              (areaContextChanged)="onAreaContextChanged($event)">
            </app-map>
          </div>
        </div>
      </div>
    </main>
  </div>
  <app-footer></app-footer>

  @if (compareIds().size > 0) {
    <app-compare-tray (compareNow)="isCompareModalOpen.set(true)"></app-compare-tray>
  }

  @if (isCompareModalOpen()) {
    <app-compare-modal [properties]="comparedProperties()" (close)="isCompareModalOpen.set(false)"></app-compare-modal>
  }
  
  @if (isDetailModalOpen() && selectedPropertyForDetail()) {
    <app-property-detail-modal [property]="selectedPropertyForDetail()!" (close)="closePropertyDetail()"></app-property-detail-modal>
  }
  
  <app-zalo-fab [zaloGroupLink]="'https://zalo.me/g/mga365'"></app-zalo-fab>
  <app-map-ai-assistant 
    (filtersApplied)="onAiFiltersApplied($event)"
    (suggestionClicked)="onAiSuggestionClicked($event)"
    [areaContext]="aiAreaContext()">
  </app-map-ai-assistant>

</div>